name: Update subscription

on:
  schedule:
    - cron: "0 3 */1 * *"
  workflow_dispatch:
  push:
    paths:
      - "src/**"
      - ".github/workflows/update.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # 保留完整历史，便于 rebase
          persist-credentials: true # 让后续 git push 使用 token

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3 pyperclip "httpx[http2]"

      - name: Ensure docs directory
        run: mkdir -p docs

      - name: Run script
        run: python fetch_sub.py

      - name: Commit and push
        shell: bash
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 如果有变更才提交
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "update subscription $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          # 先同步远程，冲突时本地（新生成的）内容优先
          # -X ours 表示冲突时选择当前分支（本地）的内容
          if ! git pull --rebase -X ours origin master; then
            echo "Rebase failed, trying to resolve conflicts automatically..."

            # 常见冲突文件的自动解决（如果你的脚本只改 docs/sub.txt，这一步就够了）
            if [ -f docs/sub.txt ]; then
              git checkout --ours docs/sub.txt
              git add docs/sub.txt
              git rebase --continue || true
            fi
          fi

          # 如果还有 rebase 未完成或失败，则回退 rebase，改用强制推送（最后保障）
          if git rebase --show-current-patch >/dev/null 2>&1; then
            echo "Rebase still in progress, aborting and force pushing..."
            git rebase --abort || true
          fi

          # 推送。若历史仍不线性（极少数情况），改用 --force-with-lease 更安全
          if ! git push origin master; then
            echo "Normal push failed, trying force-with-lease..."
            git push --force-with-lease origin master
          fi
